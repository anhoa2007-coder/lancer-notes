<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lancer Notes</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/prismjs@latest/themes/prism.css" />
</head>

<body>
    <div class="menu-bar" role="menubar" aria-label="Application menu">
        <div class="menu-item dropdown" id="menu-file" role="menuitem" tabindex="0" aria-haspopup="true"
            aria-expanded="false">File
            <div class="menu-dropdown" role="menu" aria-label="File menu">
                <button type="button" class="menu-dropdown-item" id="menu-file-new" role="menuitem">New</button>
                <button type="button" class="menu-dropdown-item" id="menu-file-open" role="menuitem">Open</button>
                <button type="button" class="menu-dropdown-item" id="menu-file-save" role="menuitem">Save</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-file-print" role="menuitem">Print</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-file-export" role="menuitem">Export
                    HTML</button>
            </div>
        </div>
        <div class="menu-item dropdown" id="menu-edit" role="menuitem" tabindex="0" aria-haspopup="true"
            aria-expanded="false">Edit
            <div class="menu-dropdown" role="menu" aria-label="Edit menu">
                <button type="button" class="menu-dropdown-item" id="menu-edit-undo" role="menuitem">Undo</button>
                <button type="button" class="menu-dropdown-item" id="menu-edit-redo" role="menuitem">Redo</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-edit-clear-format" role="menuitem">Clear
                    Formatting</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-edit-date-time" role="menuitem">Insert
                    Date/Time</button>
                <button type="button" class="menu-dropdown-item" id="menu-edit-find"
                    role="menuitem">Find/Replace</button>
                <button type="button" class="menu-dropdown-item" id="menu-edit-goto" role="menuitem">Go To Line</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-edit-search-google" role="menuitem">Search
                    with Google</button>
            </div>
        </div>
        <div class="menu-item dropdown" id="menu-view" role="menuitem" tabindex="0" aria-haspopup="true"
            aria-expanded="false">View
            <div class="menu-dropdown" role="menu" aria-label="View menu">
                <button type="button" class="menu-dropdown-item" id="menu-view-split" role="menuitem">Split</button>
                <button type="button" class="menu-dropdown-item" id="menu-view-editor" role="menuitem">Editor</button>
                <button type="button" class="menu-dropdown-item" id="menu-view-preview" role="menuitem">Preview</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-view-darkmode" role="menuitem">Dark
                    Mode</button>
                <button type="button" class="menu-dropdown-item" id="menu-view-scrollsync" role="menuitem">Scroll
                    Sync</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-view-statusbar" role="menuitem">Status
                    Bar</button>
                <button type="button" class="menu-dropdown-item" id="menu-view-wordwrap" role="menuitem">Word
                    Wrap</button>
            </div>
        </div>
        <div class="menu-item dropdown" id="menu-help" role="menuitem" tabindex="0" aria-haspopup="true"
            aria-expanded="false">Help
            <div class="menu-dropdown" role="menu" aria-label="Help menu">
                <button type="button" class="menu-dropdown-item" id="menu-help-guide" role="menuitem">Markdown
                    Guide</button>
                <button type="button" class="menu-dropdown-item" id="menu-help-changelog"
                    role="menuitem">Changelogs</button>
                <button type="button" class="menu-dropdown-item" id="menu-help-about" role="menuitem">About</button>
            </div>
        </div>

        <div class="menu-separator"></div>

        <div class="toolbar-container">
            <div class="toolbar-group">
                <button class="toolbar-btn icon-only" id="btn-bold" title="Bold"><span
                        class="material-symbols-outlined">format_bold</span></button>
                <button class="toolbar-btn icon-only" id="btn-italic" title="Italic"><span
                        class="material-symbols-outlined">format_italic</span></button>
                <button class="toolbar-btn icon-only" id="btn-code" title="Code"><span
                        class="material-symbols-outlined">code</span></button>
                <button class="toolbar-btn icon-only" id="btn-strikethrough" title="Strikethrough"><span
                        class="material-symbols-outlined">strikethrough_s</span></button>
            </div>

            <div class="toolbar-group">
                <div class="menu-item dropdown menu-item-no-padding" id="menu-headings" role="menuitem" tabindex="0"
                    aria-haspopup="true" aria-expanded="false">
                    <button class="toolbar-btn heading-dropdown-btn" id="btn-headings-dropdown" title="Headings">
                        <span id="current-heading-icon" class="material-symbols-outlined icon-18">format_h1</span>
                        <span class="dropdown-arrow">▾</span>
                    </button>
                    <div class="menu-dropdown" role="menu" aria-label="Headings menu">
                        <button type="button" class="menu-dropdown-item" id="btn-h1" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_h1</span> Title</button>
                        <button type="button" class="menu-dropdown-item" id="btn-h2" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_h2</span> Subtitle</button>
                        <button type="button" class="menu-dropdown-item" id="btn-h3" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_h3</span> Section</button>
                        <button type="button" class="menu-dropdown-item" id="btn-h4" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_h4</span> Subsection</button>
                        <button type="button" class="menu-dropdown-item" id="btn-h5" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_h5</span> Paragraph</button>
                        <button type="button" class="menu-dropdown-item" id="btn-h6" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_h6</span> Note</button>
                    </div>
                </div>
                <button class="toolbar-btn icon-only" id="btn-hr" title="Horizontal Rule"><span
                        class="material-symbols-outlined">horizontal_rule</span></button>
            </div>

            <div class="toolbar-group">
                <div class="menu-item dropdown menu-item-no-padding" id="menu-list" role="menuitem" tabindex="0"
                    aria-haspopup="true" aria-expanded="false">
                    <button class="toolbar-btn" id="btn-list-dropdown" title="Lists">
                        <span class="material-symbols-outlined">format_list_bulleted</span> ▾
                    </button>
                    <div class="menu-dropdown" role="menu" aria-label="List menu">
                        <button type="button" class="menu-dropdown-item" id="btn-bullet-list" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_list_bulleted</span>
                            Bullet List</button>
                        <button type="button" class="menu-dropdown-item" id="btn-number-list" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_list_numbered</span>
                            Numbered List</button>
                        <div class="menu-divider"></div>
                        <button type="button" class="menu-dropdown-item" id="btn-indent-increase" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_indent_increase</span>
                            Increase Indent</button>
                        <button type="button" class="menu-dropdown-item" id="btn-indent-decrease" role="menuitem"><span
                                class="material-symbols-outlined menu-icon">format_indent_decrease</span>
                            Decrease Indent</button>
                    </div>
                </div>
                <button class="toolbar-btn icon-only" id="btn-quote" title="Quote"><span
                        class="material-symbols-outlined">format_quote</span></button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn icon-only" id="btn-link" title="Insert Link"><span
                        class="material-symbols-outlined">link</span></button>
                <button class="toolbar-btn icon-only" id="btn-image" title="Insert Image"><span
                        class="material-symbols-outlined">image</span></button>

                <div class="menu-item dropdown menu-item-no-padding" id="menu-table" role="menuitem" tabindex="0"
                    aria-haspopup="true" aria-expanded="false">
                    <button class="toolbar-btn" id="btn-table" title="Insert Table">
                        <span class="material-symbols-outlined">table_chart</span>
                        <span class="dropdown-arrow">▾</span>
                    </button>
                    <div class="menu-dropdown table-dropdown" role="menu" aria-label="Table menu">
                        <div class="table-grid-container">
                            <div class="table-grid-preview" id="table-grid-preview">1 x 1</div>
                            <div class="table-grid" id="table-grid">
                                <!-- Grid cells will be generated by JavaScript -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="toolbar-group">
                <div class="view-toggle">
                    <button class="active" id="split-btn">Split</button>
                    <button id="editor-btn">Editor</button>
                    <button id="preview-btn">Preview</button>
                </div>
            </div>
        </div>


    </div>

    <div class="main-container" id="main-container">
        <div class="editor-pane" id="editor-pane">
            <div class="pane-header">Editor</div>
            <textarea class="editor-textarea" id="editor" placeholder="Start typing your markdown here...

# Welcome to Markdown Editor

This is a **bold** text and this is *italic* text.

## Features
- Real-time preview
- Syntax highlighting
- WordPad-like interface
- File operations

### Code Example
```javascript
function hello() {
    console.log('Hello, World!');
}
This is a blockquote.

Happy writing!"></textarea>
        </div>
        <div class="splitter" id="splitter"></div>

        <div class="preview-pane" id="preview-pane">
            <div class="pane-header">Preview</div>
            <div class="preview-content" id="preview"></div>
        </div>
    </div>

    <div class="status-bar">
        <div id="status-left">Ready</div>
        <div id="status-right">
            <span id="word-count">Words: 0</span>
            <span class="status-item" id="char-count">Characters: 0</span>
            <span class="status-item" id="line-count">Lines: 1</span>
        </div>
    </div>

    <!-- Find/Replace Bar -->
    <div id="find-replace-bar" class="find-replace-bar" aria-hidden="true" role="dialog" aria-label="Find and Replace"
        style="display:none;">
        <div class="fr-row">
            <div class="input-wrapper">
                <input id="find-input" class="fr-input" placeholder="Find" aria-label="Find" autocomplete="off" />
                <div id="find-history" class="history-dropdown"></div>
            </div>
            <button id="btn-find-prev" class="fr-btn" title="Previous">◀</button>
            <span id="match-count" class="fr-count" aria-live="polite">0 / 0</span>
            <button id="btn-find-next" class="fr-btn" title="Next">▶</button>
            <div class="fr-flag-dropdown" id="fr-flag-dropdown" tabindex="0" aria-haspopup="true" aria-expanded="false">
                <button class="fr-btn fr-flag-btn" id="fr-flag-btn" aria-label="Search Options"
                    title="Search Options"></button>
                <div class="fr-flag-menu" id="fr-flag-menu" role="menu" aria-hidden="true">
                    <label class="fr-checkbox"><input type="checkbox" id="case-sensitive" /> Case Sensitive</label>
                    <label class="fr-checkbox"><input type="checkbox" id="use-regex" /> Regular Expression</label>
                    <label class="fr-checkbox"><input type="checkbox" id="wrap-around" checked /> Wrap Around</label>
                    <div class="menu-divider"></div>
                    <div class="regex-flags-header">Regex Flags</div>
                    <label class="fr-checkbox"><input type="checkbox" id="flag-m" data-flag="m" class="flag-checkbox" />
                        Multiline (m)</label>
                    <label class="fr-checkbox"><input type="checkbox" id="flag-s" data-flag="s" class="flag-checkbox" />
                        Dot matches newline (s)</label>
                    <label class="fr-checkbox"><input type="checkbox" id="flag-y" data-flag="y" class="flag-checkbox" />
                        Sticky (y)</label>
                </div>
            </div>
            <button id="fr-compact-toggle" class="fr-btn fr-compact-toggle" aria-pressed="false"
                title="Toggle compact mode"></button>
            <button id="find-close" class="fr-close" aria-label="Close">✕</button>
        </div>
        <div class="fr-row">
            <div class="input-wrapper">
                <input id="replace-input" class="fr-input" placeholder="Replace" aria-label="Replace"
                    autocomplete="off" />
                <div id="replace-history" class="history-dropdown"></div>
            </div>
            <button id="btn-replace" class="fr-btn">Replace</button>
            <button id="btn-replace-all" class="fr-btn">Replace All</button>

        </div>
    </div>

    <!-- Date/Time Dialog -->
    <div id="date-time-dialog" class="generic-dialog dialog-300">
        <h3 style="margin-top:0;">Insert Date/Time</h3>
        <div style="margin-bottom:15px;">
            <div style="margin-bottom:5px; font-weight:bold;">Format</div>
            <label style="display:block; margin-bottom:5px;">
                <input type="radio" name="dt-type" value="datetime" checked> Date & Time
            </label>
            <label style="display:block; margin-bottom:5px;">
                <input type="radio" name="dt-type" value="date"> Date Only
            </label>
            <label style="display:block; margin-bottom:5px;">
                <input type="radio" name="dt-type" value="time"> Time Only
            </label>
        </div>
        <div style="margin-bottom:15px;">
            <label style="display:flex; align-items:center; cursor:pointer;">
                <input type="checkbox" id="dt-24h" style="margin-right:8px;"> Use 24-hour format
            </label>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button id="dt-cancel">Cancel</button>
            <button id="dt-insert">Insert</button>
        </div>
    </div>

    <!-- Go To Line Dialog -->
    <div id="goto-dialog" class="generic-dialog dialog-300">
        <h3 style="margin-top:0;">Go To Line</h3>
        <div style="margin-bottom:15px;">
            <label for="goto-line-input" style="display:block; margin-bottom:5px;">Line Number:</label>
            <input id="goto-line-input" type="number" min="1"
                style="width:100%; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;" />
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button id="goto-cancel">Cancel</button>
            <button id="goto-ok">Go</button>
        </div>
    </div>

    <!-- Overlay for popups -->
    <div id="popup-overlay" style="display:none;"></div>

    <!-- Link/Image Dialog -->
    <div id="link-image-dialog" class="generic-dialog dialog-400">
        <h3 id="dialog-title">Insert Link</h3>
        <div style="margin-bottom:10px;">
            <label for="dialog-url">URL</label>
            <input id="dialog-url" type="text" />
        </div>
        <div style="margin-bottom:15px;">
            <label for="dialog-text" id="dialog-text-label">Text</label>
            <input id="dialog-text" type="text" />
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button id="dialog-cancel">Cancel</button>
            <button id="dialog-ok">OK</button>
        </div>
    </div>



    <!-- Custom Alert Dialog -->
    <div id="custom-alert" class="generic-dialog dialog-450">
        <div id="custom-alert-message"></div>
        <button id="custom-alert-ok">OK</button>
    </div>



    <!-- About Dialog -->
    <div id="about-dialog" class="generic-dialog dialog-400">
        <h3>About Markdown Editor</h3>
        <div style="margin-bottom: 20px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">Markdown Editor</div>
            <div style="color: #666; margin-bottom: 5px;">Version 1.1.4</div>
            <div style="color: #666;" id="about-build-number">Build 5147</div>
        </div>
        <div style="text-align: center; color: #888; font-size: 12px; margin-bottom: 20px;">
            A lightweight, feature-rich markdown editor with live preview
        </div>
        <div class="dialog-actions">
            <button id="about-close">Close</button>
        </div>
    </div>



    <input type="file" id="file-input" class="hidden-file-input" accept=".md,.txt,.text" />

    <!-- Prism.js Syntax Highlighting (Always Latest) -->
    <script src="https://unpkg.com/prismjs@latest/prism.js"></script>

    <!-- Load main functions from external JS file -->
    <script src="function.js"></script>

    <script>
        // Global variables for state management
        let editor = document.getElementById('editor');
        let preview = document.getElementById('preview');
        let currentFile = null;
        let undoStack = [];
        let redoStack = [];
        let currentViewMode = 'split';
        let BUILD_NUMBER = '5147';

        // Find/Replace state
        let findState = {
            lastQuery: '',
            matches: [],
            currentIndex: -1
        };

        // Check if main-mdfunction.js is loaded
        if (!window.MAIN_MD_FUNCTION_LOADED) {
            alert('ERROR: main-mdfunction.js is missing!\n\nPlease ensure main-mdfunction.js is in the same directory as this HTML file.\nThe editor will not function without it.');
        }

        // Initialize the editor
        function initEditor() {
            // Check if functions are loaded
            if (typeof parseMarkdown === 'undefined') {
                alert('CRITICAL ERROR: main-mdfunction.js failed to load!\n\nThe markdown editor requires main-mdfunction.js to function.\nPlease check:\n1. main-mdfunction.js exists in: ' + window.location.pathname.replace('index.html', '') + '\n2. The file is not blocked by browser security\n3. Check browser console for errors');
                return;
            }

            // Restore dark mode if previously set
            if (localStorage.getItem('markdown-dark-mode')) {
                document.body.classList.add('dark-mode');
                if (typeof updateMenuCheck === 'function') updateMenuCheck('menu-view-darkmode', true, false);
                // Force browser to render in dark mode
                document.documentElement.style.colorScheme = 'dark';
            } else {
                if (typeof updateMenuCheck === 'function') updateMenuCheck('menu-view-darkmode', false, false);
                // Force browser to render in light mode
                document.documentElement.style.colorScheme = 'light';
            }

            // Set up event listeners
            editor.addEventListener('input', function () {
                updatePreview();
                updateStatusBar();
                saveToUndoStack();
                if (typeof updateEditMenuStates === 'function') updateEditMenuStates();
            });

            editor.addEventListener('keydown', function (e) {
                handleKeyboardShortcuts(e);
            });

            // Set up file input listener
            document.getElementById('file-input').addEventListener('change', handleFileSelect);

            // Toolbar and menu event listeners
            document.getElementById('btn-bold').addEventListener('click', function () { insertMarkdown('**', '**'); });
            document.getElementById('btn-italic').addEventListener('click', function () { insertMarkdown('*', '*'); });
            document.getElementById('btn-code').addEventListener('click', function () { insertMarkdown('`', '`'); });
            document.getElementById('btn-strikethrough').addEventListener('click', function () { insertMarkdown('~~', '~~'); });

            document.getElementById('btn-hr').addEventListener('click', insertHorizontalRule);
            document.getElementById('btn-h1').addEventListener('click', function () { insertHeading(1); closeAllMenus(); });
            document.getElementById('btn-h2').addEventListener('click', function () { insertHeading(2); closeAllMenus(); });
            document.getElementById('btn-h3').addEventListener('click', function () { insertHeading(3); closeAllMenus(); });
            document.getElementById('btn-h4').addEventListener('click', function () { insertHeading(4); closeAllMenus(); });
            document.getElementById('btn-h5').addEventListener('click', function () { insertHeading(5); closeAllMenus(); });
            document.getElementById('btn-h6').addEventListener('click', function () { insertHeading(6); closeAllMenus(); });
            document.getElementById('btn-bullet-list').addEventListener('click', function () { insertList('- '); closeAllMenus(); });
            document.getElementById('btn-number-list').addEventListener('click', function () { insertList('1. '); closeAllMenus(); });
            document.getElementById('btn-indent-increase').addEventListener('click', function () { indentText(); closeAllMenus(); });
            document.getElementById('btn-indent-decrease').addEventListener('click', function () { outdentText(); closeAllMenus(); });
            document.getElementById('btn-quote').addEventListener('click', function () { insertMarkdown('> ', ''); });
            document.getElementById('btn-link').addEventListener('click', insertLink);
            document.getElementById('btn-image').addEventListener('click', insertImage);
            document.getElementById('split-btn').addEventListener('click', function () { setViewMode('split'); });
            document.getElementById('editor-btn').addEventListener('click', function () { setViewMode('editor'); });
            document.getElementById('preview-btn').addEventListener('click', function () { setViewMode('preview'); });

            // Top menu dropdown behaviour
            function closeAllMenus() {
                document.querySelectorAll('.menu-item.dropdown.open').forEach(el => { el.classList.remove('open'); el.setAttribute('aria-expanded', 'false'); });
            }
            // Close menus when clicking outside or pressing Escape
            document.addEventListener('click', function () { closeAllMenus(); });
            document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeAllMenus(); });

            const menuItems = document.querySelectorAll('.menu-item.dropdown');
            menuItems.forEach(mi => {
                mi.addEventListener('click', function (e) {
                    const isOpen = mi.classList.contains('open');
                    closeAllMenus();
                    if (!isOpen) { mi.classList.add('open'); mi.setAttribute('aria-expanded', 'true'); }
                    e.stopPropagation();
                });
                mi.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); mi.click(); }
                    if (e.key === 'ArrowDown') { e.preventDefault(); const first = mi.querySelector('.menu-dropdown-item'); first && first.focus(); }
                });
            });

            // Menu actions
            document.getElementById('menu-file-new').addEventListener('click', function (e) { newFile(); closeAllMenus(); });
            document.getElementById('menu-file-open').addEventListener('click', function (e) { openFile(); closeAllMenus(); });
            document.getElementById('menu-file-save').addEventListener('click', function (e) { saveFile(); closeAllMenus(); });
            document.getElementById('menu-file-print').addEventListener('click', function (e) { printDocument(); closeAllMenus(); });
            document.getElementById('menu-file-export').addEventListener('click', function (e) {
                const blob = new Blob([preview.innerHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'document.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                updateStatus('Exported HTML'); closeAllMenus();
            });

            document.getElementById('menu-edit-undo').addEventListener('click', function () { undo(); closeAllMenus(); });
            document.getElementById('menu-edit-redo').addEventListener('click', function () { redo(); closeAllMenus(); });
            document.getElementById('menu-edit-clear-format').addEventListener('click', function () {
                if (!this.hasAttribute('disabled')) {
                    removeFormatting(); closeAllMenus();
                }
            });
            document.getElementById('menu-edit-date-time').addEventListener('click', function () { showDateTimeDialog(); closeAllMenus(); });
            document.getElementById('menu-edit-find').addEventListener('click', function () { toggleFindReplace(); closeAllMenus(); });
            document.getElementById('menu-edit-goto').addEventListener('click', function () {
                if (!this.hasAttribute('disabled')) {
                    showGoToDialog(); closeAllMenus();
                }
            });
            document.getElementById('menu-edit-search-google').addEventListener('click', function () {
                if (!this.hasAttribute('disabled')) {
                    searchWithGoogle(); closeAllMenus();
                }
            });

            // Update all Edit menu items state
            function updateEditMenuStates() {
                // Search with Google
                const btnGoogle = document.getElementById('menu-edit-search-google');
                if (btnGoogle) {
                    if (editor.selectionStart !== editor.selectionEnd) {
                        btnGoogle.removeAttribute('disabled');
                    } else {
                        btnGoogle.setAttribute('disabled', 'true');
                    }
                }

                // Clear Formatting
                const btnClear = document.getElementById('menu-edit-clear-format');
                if (btnClear) {
                    if (editor.selectionStart !== editor.selectionEnd) {
                        btnClear.removeAttribute('disabled');
                    } else {
                        btnClear.setAttribute('disabled', 'true');
                    }
                }

                // Go To Line
                const btnGoto = document.getElementById('menu-edit-goto');
                if (btnGoto) {
                    if (editor.value.length > 0) {
                        btnGoto.removeAttribute('disabled');
                    } else {
                        btnGoto.setAttribute('disabled', 'true');
                    }
                }
            }

            // Hook up events for menu state updates
            editor.addEventListener('mouseup', updateEditMenuStates);
            editor.addEventListener('keyup', updateEditMenuStates);
            // Also update on any selection change in the document
            document.addEventListener('selectionchange', updateEditMenuStates);

            const editMenu = document.getElementById('menu-edit');
            if (editMenu) {
                editMenu.addEventListener('mouseenter', updateEditMenuStates);
                editMenu.addEventListener('click', updateEditMenuStates);
                editMenu.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') updateEditMenuStates();
                });
            }

            document.getElementById('menu-view-split').addEventListener('click', function () { setViewMode('split'); closeAllMenus(); });
            document.getElementById('menu-view-editor').addEventListener('click', function () { setViewMode('editor'); closeAllMenus(); });
            document.getElementById('menu-view-preview').addEventListener('click', function () { setViewMode('preview'); closeAllMenus(); });
            document.getElementById('menu-view-darkmode').addEventListener('click', function () { toggleDarkMode(); closeAllMenus(); });
            document.getElementById('menu-view-statusbar').addEventListener('click', function () { toggleStatusBar(); closeAllMenus(); });
            document.getElementById('menu-view-wordwrap').addEventListener('click', function () { toggleWordWrap(); closeAllMenus(); });
            document.getElementById('menu-view-scrollsync').addEventListener('click', function () { toggleScrollSync(); closeAllMenus(); });

            document.getElementById('menu-help-guide').addEventListener('click', function () { showHelp(); closeAllMenus(); });
            document.getElementById('menu-help-changelog').addEventListener('click', function () { showAbout(); closeAllMenus(); });
            document.getElementById('menu-help-about').addEventListener('click', function () { showAboutDialog(); closeAllMenus(); });

            // Set up splitter functionality
            setupSplitter();

            // Initial preview update
            updatePreview();
            updateStatusBar();

            // Initialize status bar visibility
            if (typeof toggleStatusBar === 'function') {
                // Check local storage directly to set initial state without toggling default
                const stored = localStorage.getItem('markdown-show-statusbar');
                if (stored === '0') {
                    // If explicitely hidden, hide it (default is shown)
                    toggleStatusBar();
                }
            }
            // Initial check for status bar preference
            const showStatus = localStorage.getItem('markdown-show-statusbar');
            if (showStatus === '0') {
                document.querySelector('.status-bar').style.display = 'none';
                if (typeof updateMenuCheck === 'function') updateMenuCheck('menu-view-statusbar', false, false);
            } else {
                // Default is shown
                if (typeof updateMenuCheck === 'function') updateMenuCheck('menu-view-statusbar', true, false);
            }

            // Initial check for word wrap preference
            const noWrap = localStorage.getItem('markdown-no-wrap');
            if (noWrap === '1') {
                document.getElementById('editor').classList.add('no-wrap');
                if (typeof updateMenuCheck === 'function') updateMenuCheck('menu-view-wordwrap', false, false);
            } else {
                if (typeof updateMenuCheck === 'function') updateMenuCheck('menu-view-wordwrap', true, false);
            }

            // Init Scroll Sync
            if (typeof initScrollSync === 'function') initScrollSync();
        }

        // Wire up find/replace bar buttons
        document.addEventListener('DOMContentLoaded', function () {
            const findNextBtn = document.getElementById('btn-find-next');
            const findPrevBtn = document.getElementById('btn-find-prev');
            const replaceBtn = document.getElementById('btn-replace');
            const replaceAllBtn = document.getElementById('btn-replace-all');
            const closeBtn = document.getElementById('find-close');

            // Wire up buttons
            setupFindReplaceHistory();
            if (findNextBtn) findNextBtn.addEventListener('click', findNext);
            if (findPrevBtn) findPrevBtn.addEventListener('click', findPrev);
            if (replaceBtn) replaceBtn.addEventListener('click', replaceOne);
            if (replaceAllBtn) replaceAllBtn.addEventListener('click', replaceAll);

            if (closeBtn) closeBtn.addEventListener('click', closeFindReplace);

            // Update matches as user types
            const findInput = document.getElementById('find-input');
            if (findInput) {
                findInput.addEventListener('input', function () { updateMatches(findInput.value); });
                findInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); findNext(); } });
            }
            const replaceInputEl = document.getElementById('replace-input');
            if (replaceInputEl) {
                replaceInputEl.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); replaceOne(); } });
            }
            const caseCheckbox = document.getElementById('case-sensitive');
            if (caseCheckbox) caseCheckbox.addEventListener('change', function () { updateMatches(document.getElementById('find-input').value); });
            const regexCheckbox = document.getElementById('use-regex');
            if (regexCheckbox) regexCheckbox.addEventListener('change', function () { updateMatches(document.getElementById('find-input').value); });

            // Flag dropdown and checkbox behavior (m/s flags)
            const flagDropdown = document.getElementById('fr-flag-dropdown');
            const flagBtn = document.getElementById('fr-flag-btn');
            const flagMenu = document.getElementById('fr-flag-menu');
            // Restore stored flags
            try {
                const storedFlags = localStorage.getItem('md-fr-flags') || '';
                if (storedFlags.includes('m')) document.getElementById('flag-m').checked = true;
                if (storedFlags.includes('s')) document.getElementById('flag-s').checked = true;
                if (storedFlags.includes('y')) document.getElementById('flag-y').checked = true;
            } catch (e) { }
            // Toggle dropdown
            if (flagBtn) {
                flagBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isOpen = flagDropdown.classList.toggle('open');
                    flagBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                    flagMenu.setAttribute('aria-hidden', !isOpen);
                });
                flagBtn.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flagBtn.click(); }
                    if (e.key === 'Escape') { flagDropdown.classList.remove('open'); flagBtn.setAttribute('aria-expanded', 'false'); flagMenu.setAttribute('aria-hidden', 'true'); }
                });
            }
            document.addEventListener('click', function () { if (flagDropdown) { flagDropdown.classList.remove('open'); flagBtn && flagBtn.setAttribute('aria-expanded', 'false'); flagMenu && flagMenu.setAttribute('aria-hidden', 'true'); } });
            // Persist flag changes and update matches
            const flagCheckboxes = Array.from(document.querySelectorAll('.flag-checkbox'));
            flagCheckboxes.forEach(cb => {
                cb.addEventListener('change', function () {
                    const flags = Array.from(document.querySelectorAll('.flag-checkbox:checked')).map(c => c.getAttribute('data-flag')).join('');
                    try { localStorage.setItem('md-fr-flags', flags); } catch (e) { }
                    updateMatches(document.getElementById('find-input').value);
                });
            });

            // Close find bar when pressing Escape while focused inside
            const findBar = document.getElementById('find-replace-bar');
            findBar && findBar.addEventListener('keydown', function (e) { if (e.key === 'Escape') { closeFindReplace(); } });
            // Prevent clicks inside the find bar from bubbling and closing menus
            findBar && findBar.addEventListener('click', function (e) { e.stopPropagation(); });

            // Compact mode toggle & persistence
            const compactToggle = document.getElementById('fr-compact-toggle');
            function setCompactMode(state) {
                const findBar = document.getElementById('find-replace-bar');
                if (!findBar) return;
                if (state) {
                    findBar.classList.add('compact');
                    if (compactToggle) { compactToggle.setAttribute('aria-pressed', 'true'); }
                } else {
                    findBar.classList.remove('compact');
                    if (compactToggle) { compactToggle.setAttribute('aria-pressed', 'false'); }
                }
                try { localStorage.setItem('md-fr-compact', state ? '1' : '0'); } catch (e) { }
            }
            if (compactToggle) {
                compactToggle.addEventListener('click', function () { setCompactMode(!document.getElementById('find-replace-bar').classList.contains('compact')); });
                try { const storedCompact = localStorage.getItem('md-fr-compact'); if (storedCompact === '1') setCompactMode(true); } catch (e) { }
            }

            // Also close when clicking overlay
            var overlay = document.getElementById('popup-overlay');
            if (overlay) overlay.addEventListener('click', function () {
                // Close all open dialogs
                document.querySelectorAll('.generic-dialog.open').forEach(function (dialog) {
                    if (typeof closeDialogElement === 'function') {
                        closeDialogElement(dialog);
                    } else {
                        dialog.classList.remove('open');
                        setTimeout(function () {
                            if (!dialog.classList.contains('open')) {
                                dialog.style.display = 'none';
                            }
                        }, 250);
                    }
                });
                // Hide overlay
                if (typeof hideOverlay === 'function') {
                    hideOverlay();
                } else {
                    overlay.classList.remove('open');
                    setTimeout(function () {
                        if (!overlay.classList.contains('open')) {
                            overlay.style.display = 'none';
                        }
                    }, 300);
                }
            });

            // Close on Escape when bar is open
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const bar = document.getElementById('find-replace-bar');
                    if (bar && bar.style.display !== 'none') { closeFindReplace(); }
                }
            });

            // Initialize Animated Icons
            if (typeof initAnimatedIcons === 'function') {
                initAnimatedIcons();
            }

            // Initialize Table Grid Selector
            if (typeof initTableGrid === 'function') {
                initTableGrid();
            }

        });

        // Handle image info badge clicks
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('md-img-info-badge')) {
                // Hide any other open popups
                document.querySelectorAll('.md-img-info-popup').forEach(popup => {
                    if (popup !== e.target.nextElementSibling) {
                        popup.style.display = 'none';
                    }
                });

                // Toggle this popup
                const popup = e.target.nextElementSibling;
                popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
            } else if (!e.target.closest('.md-img-info-popup')) {
                // Click outside popup - hide all popups
                document.querySelectorAll('.md-img-info-popup').forEach(popup => {
                    popup.style.display = 'none';
                });
            }
        });

        // Initialize the editor when page loads
        window.addEventListener('load', initEditor);
    </script>
</body>

</html>