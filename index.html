<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lancer Notes</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css" />
</head>


<body>
    <div class="menu-bar" role="menubar" aria-label="Application menu">
        <div class="menu-item dropdown" id="menu-file" role="menuitem" tabindex="0" aria-haspopup="true"
            aria-expanded="false">File
            <div class="menu-dropdown" role="menu" aria-label="File menu">
                <button type="button" class="menu-dropdown-item" id="menu-file-new" role="menuitem">New</button>
                <button type="button" class="menu-dropdown-item" id="menu-file-open" role="menuitem">Open</button>
                <button type="button" class="menu-dropdown-item" id="menu-file-save" role="menuitem">Save</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-file-export" role="menuitem">Export
                    HTML</button>
            </div>
        </div>
        <div class="menu-item dropdown" id="menu-edit" role="menuitem" tabindex="0" aria-haspopup="true"
            aria-expanded="false">Edit
            <div class="menu-dropdown" role="menu" aria-label="Edit menu">
                <button type="button" class="menu-dropdown-item" id="menu-edit-undo" role="menuitem">Undo</button>
                <button type="button" class="menu-dropdown-item" id="menu-edit-redo" role="menuitem">Redo</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-edit-find"
                    role="menuitem">Find/Replace</button>
            </div>
        </div>
        <div class="menu-item dropdown" id="menu-view" role="menuitem" tabindex="0" aria-haspopup="true"
            aria-expanded="false">View
            <div class="menu-dropdown" role="menu" aria-label="View menu">
                <button type="button" class="menu-dropdown-item" id="menu-view-split" role="menuitem">Split</button>
                <button type="button" class="menu-dropdown-item" id="menu-view-editor" role="menuitem">Editor</button>
                <button type="button" class="menu-dropdown-item" id="menu-view-preview" role="menuitem">Preview</button>
                <div class="menu-divider"></div>
                <button type="button" class="menu-dropdown-item" id="menu-view-darkmode" role="menuitem">Toggle Dark
                    Mode</button>
            </div>
        </div>
        <div class="menu-item dropdown" id="menu-help" role="menuitem" tabindex="0" aria-haspopup="true"
            aria-expanded="false">Help
            <div class="menu-dropdown" role="menu" aria-label="Help menu">
                <button type="button" class="menu-dropdown-item" id="menu-help-guide" role="menuitem">Markdown
                    Guide</button>
                <button type="button" class="menu-dropdown-item" id="menu-help-changelog"
                    role="menuitem">Changelogs</button>
                <button type="button" class="menu-dropdown-item" id="menu-help-about" role="menuitem">About</button>
            </div>
        </div>
    </div>

    <div class="toolbar">



        <div class="toolbar-group">
            <button class="toolbar-btn icon-only" id="btn-bold" title="Bold"><span
                    class="material-symbols-outlined">format_bold</span></button>
            <button class="toolbar-btn icon-only" id="btn-italic" title="Italic"><span
                    class="material-symbols-outlined">format_italic</span></button>
            <button class="toolbar-btn icon-only" id="btn-code" title="Code"><span
                    class="material-symbols-outlined">code</span></button>
            <button class="toolbar-btn" id="btn-hr" title="Horizontal Rule"><span
                    class="material-symbols-outlined">horizontal_rule</span> HR</button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn icon-only" id="btn-h1" title="Heading 1"><span
                    class="material-symbols-outlined">format_h1</span></button>
            <button class="toolbar-btn icon-only" id="btn-h2" title="Heading 2"><span
                    class="material-symbols-outlined">format_h2</span></button>
            <button class="toolbar-btn icon-only" id="btn-h3" title="Heading 3"><span
                    class="material-symbols-outlined">format_h3</span></button>
        </div>



        <div class="toolbar-group">
            <button class="toolbar-btn" id="btn-bullet-list" title="Bullet List"><span
                    class="material-symbols-outlined">format_list_bulleted</span> List</button>
            <button class="toolbar-btn" id="btn-number-list" title="Numbered List"><span
                    class="material-symbols-outlined">format_list_numbered</span> List</button>
            <button class="toolbar-btn" id="btn-quote" title="Quote"><span
                    class="material-symbols-outlined">format_quote</span> Quote</button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" id="btn-link" title="Insert Link"><span
                    class="material-symbols-outlined">link</span> Link</button>
            <button class="toolbar-btn" id="btn-image" title="Insert Image"><span
                    class="material-symbols-outlined">image</span> Image</button>
        </div>
        <!-- Removed duplicate dark mode button -->
        <div class="toolbar-group">
            <div class="view-toggle">
                <button class="active" id="split-btn">Split</button>
                <button id="editor-btn">Editor</button>
                <button id="preview-btn">Preview</button>
            </div>
        </div>


    </div>

    <div class="main-container" id="main-container">
        <div class="editor-pane" id="editor-pane">
            <div class="pane-header">Editor</div>
            <textarea class="editor-textarea" id="editor" placeholder="Start typing your markdown here...

# Welcome to Lancer Notes!

This is a **bold** text and this is *italic* text.

## Features
- Real-time preview
- Syntax highlighting
- WordPad-like interface
- File operations

### Code Example
```javascript
function hello() {
    console.log('Hello, World!');
}```
> This is a blockquote.

Happy writing!"></textarea>
        </div>
        <div class="splitter" id="splitter"></div>

        <div class="preview-pane" id="preview-pane">
            <div class="pane-header">Preview</div>
            <div class="preview-content" id="preview"></div>
        </div>
    </div>

    <div class="status-bar">
        <div id="status-left">Ready</div>
        <div id="status-right">
            <span id="word-count">Words: 0</span>
            <span style="margin-left: 20px;" id="char-count">Characters: 0</span>
            <span style="margin-left: 20px;" id="line-count">Lines: 1</span>
        </div>
    </div>

    <!-- Find/Replace Bar -->
    <div id="find-replace-bar" class="find-replace-bar" aria-hidden="true" role="dialog" aria-label="Find and Replace"
        style="display:none;">
        <div class="fr-row">
            <input id="find-input" class="fr-input" placeholder="Find" aria-label="Find" />
            <button id="btn-find-prev" class="fr-btn" title="Previous">◀</button>
            <button id="btn-find-next" class="fr-btn" title="Next">▶</button>
            <span id="match-count" class="fr-count" aria-live="polite">0 / 0</span>
            <button id="fr-compact-toggle" class="fr-btn fr-compact-toggle" aria-pressed="false"
                title="Toggle compact mode">⋯</button>
            <button id="find-close" class="fr-close" aria-label="Close">✕</button>
        </div>
        <div class="fr-row" style="margin-top:8px;">
            <input id="replace-input" class="fr-input" placeholder="Replace" aria-label="Replace" />
            <button id="btn-replace" class="fr-btn">Replace</button>
            <button id="btn-replace-all" class="fr-btn">Replace All</button>
            <label class="fr-checkbox"><input type="checkbox" id="case-sensitive" /> Case</label>
            <label class="fr-checkbox"><input type="checkbox" id="use-regex" /> Regex</label>
            <div class="fr-flag-dropdown" id="fr-flag-dropdown" tabindex="0" aria-haspopup="true" aria-expanded="false">
                <button class="fr-btn fr-flag-btn" id="fr-flag-btn" aria-label="Regex Flags">Flags ▾</button>
                <div class="fr-flag-menu" id="fr-flag-menu" role="menu" aria-hidden="true">
                    <label class="fr-checkbox"><input type="checkbox" id="flag-m" data-flag="m" class="flag-checkbox" />
                        m</label>
                    <label class="fr-checkbox"><input type="checkbox" id="flag-s" data-flag="s" class="flag-checkbox" />
                        s</label>
                </div>
            </div>
            <select id="search-history" class="fr-history">
                <option value="">Recent searches...</option>
            </select>
        </div>
    </div>

    <!-- Overlay for popups -->
    <div id="popup-overlay" style="display:none;"></div>

    <!-- Link/Image Dialog -->
    <div id="link-image-dialog" style="display:none;">
        <h3 id="dialog-title">Insert Link</h3>
        <div style="margin-bottom:10px;">
            <label for="dialog-url">URL</label>
            <input id="dialog-url" type="text" />
        </div>
        <div style="margin-bottom:15px;">
            <label for="dialog-text" id="dialog-text-label">Text</label>
            <input id="dialog-text" type="text" />
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button id="dialog-cancel">Cancel</button>
            <button id="dialog-ok">OK</button>
        </div>
    </div>


    <!-- Custom Alert Dialog -->
    <div id="custom-alert" style="display:none;">
        <div id="custom-alert-message"></div>
        <button id="custom-alert-ok">OK</button>
    </div>

    <!-- Markdown Guide Help Popup -->
    <div id="help-popup" style="display:none;">
        <div
            style="background:#007acc;color:#fff;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;">
            <span style="font-weight:bold;">Markdown Guide</span>
            <button id="help-popup-close">&times;</button>
        </div>
        <iframe src="https://www.markdownguide.org/basic-syntax/"></iframe>
    </div>

    <!-- Changelog Popup -->
    <div id="changelog-popup" style="display:none;">
        <div
            style="background:#007acc;color:#fff;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;">
            <span style="font-weight:bold;">Changelogs</span>
            <button id="changelog-popup-close">&times;</button>
        </div>
        <iframe src="https://objectpresents.github.io/lancer-notes/"></iframe>
    </div>

    <input type="file" id="file-input" class="hidden-file-input" accept=".md,.txt,.text" />

    <script>
        // Global variables for state management

        let editor = document.getElementById('editor');
        let preview = document.getElementById('preview');
        let currentFile = null;
        let undoStack = [];
        let redoStack = [];
        let currentViewMode = 'split';
        let BUILD_NUMBER = '4418';

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            // Optionally persist mode
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('markdown-dark-mode', '1');
            } else {
                localStorage.removeItem('markdown-dark-mode');
            }
        }

        // Initialize the editor
        function initEditor() {


            // Restore dark mode if previously set
            if (localStorage.getItem('markdown-dark-mode')) {
                document.body.classList.add('dark-mode');
            }
            // Set build number display and document title
            try { document.getElementById('build-number').textContent = 'Build ' + BUILD_NUMBER; } catch (e) { }
            document.title = document.title + ' - Build ' + BUILD_NUMBER;
            // Set up event listeners
            editor.addEventListener('input', function () {
                updatePreview();
                updateStatusBar();
                saveToUndoStack();
            });

            editor.addEventListener('keydown', function (e) {
                handleKeyboardShortcuts(e);
            });

            // Set up file input listener
            document.getElementById('file-input').addEventListener('change', handleFileSelect);

            // Toolbar and menu event listeners
            document.getElementById('btn-bold').addEventListener('click', function () { insertMarkdown('**', '**'); });
            document.getElementById('btn-italic').addEventListener('click', function () { insertMarkdown('*', '*'); });
            document.getElementById('btn-code').addEventListener('click', function () { insertMarkdown('`', '`'); });
            document.getElementById('btn-hr').addEventListener('click', insertHorizontalRule);
            document.getElementById('btn-h1').addEventListener('click', function () { insertHeading(1); });
            document.getElementById('btn-h2').addEventListener('click', function () { insertHeading(2); });
            document.getElementById('btn-h3').addEventListener('click', function () { insertHeading(3); });
            document.getElementById('btn-bullet-list').addEventListener('click', function () { insertList('- '); });
            document.getElementById('btn-number-list').addEventListener('click', function () { insertList('1. '); });
            document.getElementById('btn-quote').addEventListener('click', function () { insertMarkdown('> ', ''); });
            document.getElementById('btn-link').addEventListener('click', insertLink);
            document.getElementById('btn-image').addEventListener('click', insertImage);
            document.getElementById('split-btn').addEventListener('click', function () { setViewMode('split'); });
            document.getElementById('editor-btn').addEventListener('click', function () { setViewMode('editor'); });
            document.getElementById('preview-btn').addEventListener('click', function () { setViewMode('preview'); });

            // Top menu dropdown behaviour
            function closeAllMenus() {
                document.querySelectorAll('.menu-item.dropdown.open').forEach(el => { el.classList.remove('open'); el.setAttribute('aria-expanded', 'false'); });
            }
            // Close menus when clicking outside or pressing Escape
            document.addEventListener('click', function () { closeAllMenus(); });
            document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeAllMenus(); });

            const menuItems = document.querySelectorAll('.menu-item.dropdown');
            menuItems.forEach(mi => {
                mi.addEventListener('click', function (e) {
                    const isOpen = mi.classList.contains('open');
                    closeAllMenus();
                    if (!isOpen) { mi.classList.add('open'); mi.setAttribute('aria-expanded', 'true'); }
                    e.stopPropagation();
                });
                mi.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); mi.click(); }
                    if (e.key === 'ArrowDown') { e.preventDefault(); const first = mi.querySelector('.menu-dropdown-item'); first && first.focus(); }
                });
            });

            // Menu actions
            document.getElementById('menu-file-new').addEventListener('click', function (e) { newFile(); closeAllMenus(); });
            document.getElementById('menu-file-open').addEventListener('click', function (e) { openFile(); closeAllMenus(); });
            document.getElementById('menu-file-save').addEventListener('click', function (e) { saveFile(); closeAllMenus(); });
            document.getElementById('menu-file-export').addEventListener('click', function (e) {
                const blob = new Blob([preview.innerHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'document.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                updateStatus('Exported HTML'); closeAllMenus();
            });

            document.getElementById('menu-edit-undo').addEventListener('click', function () { undo(); closeAllMenus(); });
            document.getElementById('menu-edit-redo').addEventListener('click', function () { redo(); closeAllMenus(); });
            document.getElementById('menu-edit-find').addEventListener('click', function () { toggleFindReplace(); closeAllMenus(); });

            document.getElementById('menu-view-split').addEventListener('click', function () { setViewMode('split'); closeAllMenus(); });
            document.getElementById('menu-view-editor').addEventListener('click', function () { setViewMode('editor'); closeAllMenus(); });
            document.getElementById('menu-view-preview').addEventListener('click', function () { setViewMode('preview'); closeAllMenus(); });
            document.getElementById('menu-view-darkmode').addEventListener('click', function () { toggleDarkMode(); closeAllMenus(); });

            document.getElementById('menu-help-guide').addEventListener('click', function () { showHelp(); closeAllMenus(); });
            document.getElementById('menu-help-changelog').addEventListener('click', function () { showAbout(); closeAllMenus(); });
            document.getElementById('menu-help-about').addEventListener('click', function () { customAlert('Lancer Notes\nVersion: 1.0.1 (Build ' + BUILD_NUMBER + ')'); closeAllMenus(); });



            // Set up splitter functionality
            setupSplitter();

            // Initial preview update
            updatePreview();
            updateStatusBar();
        }

        // Find & Replace functionality
        let findState = {
            lastQuery: '',
            matches: [],
            currentIndex: -1
        };
        let searchHistory = [];

        function toggleFindReplace(openReplace) {
            const bar = document.getElementById('find-replace-bar');
            if (bar.style.display === 'none' || bar.style.display === '') {
                // Ensure centered position and accessibility attributes
                bar.style.left = '50%'; bar.style.right = 'auto'; bar.style.transform = 'translateX(-50%)';
                bar.style.display = 'block';
                bar.setAttribute('aria-hidden', 'false');
                bar.setAttribute('aria-controls', 'editor');
                document.getElementById('find-input').focus();
                updateMatches(document.getElementById('find-input').value || '');
            } else {
                bar.style.display = 'none';
                bar.setAttribute('aria-hidden', 'true');
                editor.focus();
            }
        }

        // Close on Escape when bar is open
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const bar = document.getElementById('find-replace-bar');
                if (bar && bar.style.display === 'block') { bar.style.display = 'none'; bar.setAttribute('aria-hidden', 'true'); editor.focus(); }
            }
        });

        function updateMatches(query) {
            findState.matches = [];
            findState.currentIndex = -1;
            const cs = document.getElementById('case-sensitive') && document.getElementById('case-sensitive').checked;
            const useRegex = document.getElementById('use-regex') && document.getElementById('use-regex').checked;
            if (!query) { updateMatchCount(); return; }
            const text = editor.value;
            if (useRegex) {
                // build flags string from flag checkboxes
                let flags = 'g';
                if (!cs) flags += 'i';
                document.querySelectorAll('.flag-checkbox:checked').forEach(b => { const f = b.getAttribute('data-flag'); if (f && !flags.includes(f)) flags += f; });
                let re;
                try {
                    re = new RegExp(query, flags);
                } catch (err) {
                    const el = document.getElementById('match-count'); if (el) el.textContent = 'Invalid regex';
                    return;
                }
                let m;
                while ((m = re.exec(text)) !== null) {
                    findState.matches.push({ start: m.index, end: m.index + m[0].length });
                    if (m.index === re.lastIndex) re.lastIndex++; // avoid infinite loop on zero-length matches
                }
                updateMatchCount();
                // Highlight matches in preview for regex mode as well
                highlightMatches();
                return;
            }
            // plain substring search
            let hay = text;
            let needle = query;
            if (!cs) { hay = text.toLowerCase(); needle = query.toLowerCase(); }
            let startIndex = 0;
            while (true) {
                const idx = hay.indexOf(needle, startIndex);
                if (idx === -1) break;
                findState.matches.push({ start: idx, end: idx + query.length });
                startIndex = idx + query.length;
            }
            updateMatchCount();
            highlightMatches();
        }

        function escapeHtml(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

        // Highlight matches in preview pane (best-effort): we'll replace preview innerHTML with highlighted content
        function highlightMatches() {
            try {
                const text = editor.value;
                const useRegex = document.getElementById('use-regex') && document.getElementById('use-regex').checked;
                const cs = document.getElementById('case-sensitive') && document.getElementById('case-sensitive').checked;
                const flagM = document.getElementById('flag-m') && document.getElementById('flag-m').checked;
                const flagS = document.getElementById('flag-s') && document.getElementById('flag-s').checked;
                const q = document.getElementById('find-input').value;
                if (!q) { updatePreview(); return; }
                // Build regex or literal
                let re;
                if (useRegex) {
                    // build flags from flag checkboxes
                    let flags = 'g'; if (!cs) flags += 'i';
                    document.querySelectorAll('.flag-checkbox:checked').forEach(b => { const f = b.getAttribute('data-flag'); if (f && !flags.includes(f)) flags += f; });
                    try { re = new RegExp(q, flags); } catch (err) { const el = document.getElementById('match-count'); if (el) el.textContent = 'Invalid regex'; return; }
                } else {
                    const esc = q.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
                    let flags = 'g'; if (!cs) flags += 'i'; if (flagM) flags += 'm'; if (flagS) flags += 's';
                    // also include other checked flags
                    document.querySelectorAll('.flag-checkbox:checked').forEach(b => { const f = b.getAttribute('data-flag'); if (f && !flags.includes(f)) flags += f; });
                    re = new RegExp(esc, flags);
                }

                // Use preview HTML from markdown, but we will operate on text only: highlight in preview by work-around — simple replace on escaped text
                const escaped = escapeHtml(text);
                let idx = 0; let out = ''; let m; let lastEnd = 0; let matchIndex = 0;
                while ((m = re.exec(text)) !== null) {
                    const start = m.index; const end = m.index + m[0].length;
                    out += escapeHtml(text.substring(lastEnd, start));
                    const cls = (findState.currentIndex === matchIndex) ? 'md-match-current find-transition' : 'md-match find-transition';
                    out += `<span class="${cls}">` + escapeHtml(m[0]) + `</span>`;
                    lastEnd = end;
                    matchIndex++;
                    if (m.index === re.lastIndex) re.lastIndex++; // avoid zero-length match infinite loop
                }
                out += escapeHtml(text.substring(lastEnd));
                // Convert newlines to <br> to mimic preview
                out = out.replace(/\n/g, '<br>');
                preview.innerHTML = out;
            } catch (err) {
                // on error, fallback to normal preview
                updatePreview();
            }
        }

        function highlightMatch(index) {
            if (index < 0 || index >= findState.matches.length) return;
            const m = findState.matches[index];
            editor.selectionStart = m.start;
            editor.selectionEnd = m.end;
            editor.focus();
            updateMatchCount();
        }

        function updateMatchCount() {
            const el = document.getElementById('match-count');
            const total = findState.matches.length;
            const current = (findState.currentIndex >= 0 && total > 0) ? (findState.currentIndex + 1) : 0;
            if (el) el.textContent = `${current} / ${total}`;
        }

        function findNext() {
            const q = document.getElementById('find-input').value;
            if (q !== findState.lastQuery) {
                findState.lastQuery = q;
                updateMatches(q);
            }
            if (findState.matches.length === 0) return;
            findState.currentIndex = (findState.currentIndex + 1) % findState.matches.length;
            highlightMatch(findState.currentIndex);
            highlightMatches();
        }

        function findPrev() {
            const q = document.getElementById('find-input').value;
            if (q !== findState.lastQuery) {
                findState.lastQuery = q;
                updateMatches(q);
            }
            if (findState.matches.length === 0) return;
            findState.currentIndex = (findState.currentIndex - 1 + findState.matches.length) % findState.matches.length;
            highlightMatch(findState.currentIndex);
            highlightMatches();
        }

        function replaceOne() {
            const q = document.getElementById('find-input').value;
            const r = document.getElementById('replace-input').value;
            if (!q) return;
            // If regex mode, use regex replace semantics
            const cs = document.getElementById('case-sensitive') && document.getElementById('case-sensitive').checked;
            const useRegex = document.getElementById('use-regex') && document.getElementById('use-regex').checked;
            if (useRegex) {
                try {
                    const flags = cs ? '' : 'i';
                    const re = new RegExp(q, flags);
                    const selected = editor.value.substring(editor.selectionStart, editor.selectionEnd);
                    if (selected && re.test(selected)) {
                        saveToUndoStack();
                        const replaced = selected.replace(re, r);
                        editor.setRangeText(replaced, editor.selectionStart, editor.selectionEnd, 'end');
                        updatePreview(); updateStatusBar(); updateMatches(q); return;
                    }
                    findNext();
                    const sel = editor.value.substring(editor.selectionStart, editor.selectionEnd);
                    if (sel && re.test(sel)) {
                        saveToUndoStack();
                        const replaced2 = sel.replace(re, r);
                        editor.setRangeText(replaced2, editor.selectionStart, editor.selectionEnd, 'end');
                        updatePreview(); updateStatusBar(); updateMatches(q);
                    }
                } catch (err) {
                    const el = document.getElementById('match-count'); if (el) el.textContent = 'Invalid regex';
                }
                return;
            }
            // plain substring replace
            const selected = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            const matchesSelected = selected && ((cs && selected === q) || (!cs && selected.toLowerCase() === q.toLowerCase()));
            if (matchesSelected) {
                saveToUndoStack();
                editor.setRangeText(r, editor.selectionStart, editor.selectionEnd, 'end');
                updatePreview();
                updateStatusBar();
                updateMatches(q);
            } else {
                findNext();
                const sel = editor.value.substring(editor.selectionStart, editor.selectionEnd);
                const selMatches = sel && ((cs && sel === q) || (!cs && sel.toLowerCase() === q.toLowerCase()));
                if (selMatches) {
                    saveToUndoStack();
                    editor.setRangeText(r, editor.selectionStart, editor.selectionEnd, 'end');
                    updatePreview();
                    updateStatusBar();
                    updateMatches(q);
                }
            }
        }

        function replaceAll() {
            const q = document.getElementById('find-input').value;
            const r = document.getElementById('replace-input').value;
            if (!q) return;
            const cs = document.getElementById('case-sensitive') && document.getElementById('case-sensitive').checked;
            const useRegex = document.getElementById('use-regex') && document.getElementById('use-regex').checked;
            const text = editor.value;
            if (useRegex) {
                let flags = 'g'; if (!cs) flags += 'i';
                // include any checked flag checkboxes
                document.querySelectorAll('.flag-checkbox:checked').forEach(b => { const f = b.getAttribute('data-flag'); if (f && !flags.includes(f)) flags += f; });
                try {
                    const re = new RegExp(q, flags);
                    if (!re.test(text)) return;
                    saveToUndoStack();
                    editor.value = text.replace(re, r);
                    updatePreview(); updateStatusBar(); updateMatches(q);
                } catch (err) {
                    const el = document.getElementById('match-count'); if (el) el.textContent = 'Invalid regex';
                }
                return;
            }
            const hay = cs ? text : text.toLowerCase();
            const needle = cs ? q : q.toLowerCase();
            if (hay.indexOf(needle) === -1) return;
            saveToUndoStack();
            if (cs) {
                editor.value = text.split(q).join(r);
            } else {
                // Case-insensitive replace: do a simple global replace
                let result = '';
                let idx = 0;
                while (idx < text.length) {
                    const segment = text.substring(idx);
                    const pos = segment.toLowerCase().indexOf(needle);
                    if (pos === -1) { result += segment; break; }
                    result += segment.substring(0, pos) + r;
                    idx += pos + q.length;
                }
                editor.value = result;
            }
            updatePreview(); updateStatusBar(); updateMatches(q);
        }

        // Wire up find/replace bar buttons
        document.addEventListener('DOMContentLoaded', function () {
            // Because our initEditor runs on window.load, also ensure these buttons exist by waiting DOMContentLoaded
            const findNextBtn = document.getElementById('btn-find-next');
            const findPrevBtn = document.getElementById('btn-find-prev');
            const replaceBtn = document.getElementById('btn-replace');
            const replaceAllBtn = document.getElementById('btn-replace-all');
            const closeBtn = document.getElementById('find-close');

            // Search history helper function (defined early so button handlers can use it)
            const historyEl = document.getElementById('search-history');
            try {
                const stored = localStorage.getItem('md-search-history');
                if (stored) searchHistory = JSON.parse(stored);
            } catch (e) { searchHistory = []; }
            function refreshHistory() {
                historyEl.innerHTML = '<option value="">Recent searches...</option>' + searchHistory.map(s => `<option>${s}</option>`).join('');
            }
            refreshHistory();
            historyEl.addEventListener('change', function () { if (historyEl.value) { document.getElementById('find-input').value = historyEl.value; updateMatches(historyEl.value); } });

            function pushHistory(q) {
                if (!q) return;
                const idx = searchHistory.indexOf(q);
                if (idx !== -1) searchHistory.splice(idx, 1);
                searchHistory.unshift(q);
                if (searchHistory.length > 20) searchHistory.pop();
                try { localStorage.setItem('md-search-history', JSON.stringify(searchHistory)); } catch (e) { }
                refreshHistory();
            }

            // Wire up buttons with integrated history push
            if (findNextBtn) findNextBtn.addEventListener('click', function () {
                const q = document.getElementById('find-input').value;
                if (q) pushHistory(q);
                findNext();
            });
            if (findPrevBtn) findPrevBtn.addEventListener('click', function () {
                const q = document.getElementById('find-input').value;
                if (q) pushHistory(q);
                findPrev();
            });
            if (replaceBtn) replaceBtn.addEventListener('click', function () {
                const q = document.getElementById('find-input').value;
                if (q) pushHistory(q);
                replaceOne();
            });
            if (replaceAllBtn) replaceAllBtn.addEventListener('click', function () {
                const q = document.getElementById('find-input').value;
                if (q) pushHistory(q);
                replaceAll();
            });
            if (closeBtn) closeBtn.addEventListener('click', function () { const bar = document.getElementById('find-replace-bar'); if (bar) { bar.style.display = 'none'; bar.setAttribute('aria-hidden', 'true'); } editor.focus(); });

            // Update matches as user types
            const findInput = document.getElementById('find-input');
            if (findInput) {
                findInput.addEventListener('input', function () { updateMatches(findInput.value); });
                findInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); findNext(); } });
            }
            const replaceInputEl = document.getElementById('replace-input');
            if (replaceInputEl) {
                replaceInputEl.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); replaceOne(); } });
            }
            const caseCheckbox = document.getElementById('case-sensitive');
            if (caseCheckbox) caseCheckbox.addEventListener('change', function () { updateMatches(document.getElementById('find-input').value); });
            const regexCheckbox = document.getElementById('use-regex');
            if (regexCheckbox) regexCheckbox.addEventListener('change', function () { updateMatches(document.getElementById('find-input').value); });

            // Flag dropdown and checkbox behavior (m/s flags)
            const flagDropdown = document.getElementById('fr-flag-dropdown');
            const flagBtn = document.getElementById('fr-flag-btn');
            const flagMenu = document.getElementById('fr-flag-menu');
            // Restore stored flags
            try {
                const storedFlags = localStorage.getItem('md-fr-flags') || '';
                if (storedFlags.includes('m')) document.getElementById('flag-m').checked = true;
                if (storedFlags.includes('s')) document.getElementById('flag-s').checked = true;
            } catch (e) { }
            // Toggle dropdown
            if (flagBtn) {
                flagBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isOpen = flagDropdown.classList.toggle('open');
                    flagBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                    flagMenu.setAttribute('aria-hidden', !isOpen);
                });
                flagBtn.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flagBtn.click(); }
                    if (e.key === 'Escape') { flagDropdown.classList.remove('open'); flagBtn.setAttribute('aria-expanded', 'false'); flagMenu.setAttribute('aria-hidden', 'true'); }
                });
            }
            document.addEventListener('click', function () { if (flagDropdown) { flagDropdown.classList.remove('open'); flagBtn && flagBtn.setAttribute('aria-expanded', 'false'); flagMenu && flagMenu.setAttribute('aria-hidden', 'true'); } });
            // Persist flag changes and update matches
            const flagCheckboxes = Array.from(document.querySelectorAll('.flag-checkbox'));
            flagCheckboxes.forEach(cb => {
                cb.addEventListener('change', function () {
                    const flags = Array.from(document.querySelectorAll('.flag-checkbox:checked')).map(c => c.getAttribute('data-flag')).join('');
                    try { localStorage.setItem('md-fr-flags', flags); } catch (e) { }
                    updateMatches(document.getElementById('find-input').value);
                });
            });

            // Close find bar when pressing Escape while focused inside
            const findBar = document.getElementById('find-replace-bar');
            findBar && findBar.addEventListener('keydown', function (e) { if (e.key === 'Escape') { findBar.style.display = 'none'; findBar.setAttribute('aria-hidden', 'true'); editor.focus(); } });
            // Prevent clicks inside the find bar from bubbling and closing menus
            findBar && findBar.addEventListener('click', function (e) { e.stopPropagation(); });

            // Compact mode toggle & persistence
            const compactToggle = document.getElementById('fr-compact-toggle');
            function setCompactMode(state) {
                const findBar = document.getElementById('find-replace-bar');
                if (!findBar) return;
                if (state) {
                    findBar.classList.add('compact');
                    if (compactToggle) { compactToggle.setAttribute('aria-pressed', 'true'); compactToggle.textContent = '▴'; }
                } else {
                    findBar.classList.remove('compact');
                    if (compactToggle) { compactToggle.setAttribute('aria-pressed', 'false'); compactToggle.textContent = '⋯'; }
                }
                try { localStorage.setItem('md-fr-compact', state ? '1' : '0'); } catch (e) { }
            }
            if (compactToggle) {
                compactToggle.addEventListener('click', function () { setCompactMode(!document.getElementById('find-replace-bar').classList.contains('compact')); });
                try { const storedCompact = localStorage.getItem('md-fr-compact'); if (storedCompact === '1') setCompactMode(true); } catch (e) { }
            }
        });

        // Extend keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'n':
                        e.preventDefault();
                        newFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        openFile();
                        break;
                    case 's':
                        e.preventDefault();
                        saveFile();
                        break;
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                        break;
                    case 'b':
                        e.preventDefault();
                        insertMarkdown('**', '**');
                        break;
                    case 'i':
                        e.preventDefault();
                        insertMarkdown('*', '*');
                        break;
                    case 'f':
                        e.preventDefault();
                        toggleFindReplace();
                        break;
                    case 'h':
                        e.preventDefault();
                        // open and focus replace field
                        toggleFindReplace();
                        document.getElementById('replace-input').focus();
                        break;
                }
            }
        }

        // Markdown parsing function - converts markdown to HTML
        function parseMarkdown(markdown) {
            let html = markdown;



            // Handle escaped characters first
            html = html.replace(/\\([\\`\*_{}\[\]()#+\-.!|])/g, function (match, p1) { return '@@ESCAPED:' + p1.charCodeAt(0).toString(16) + '@@'; });



            // Blockquotes: support nested blockquotes using multiple > at line start
            function parseBlockquotes(text) {
                const lines = text.split(/\r?\n/);
                let result = [];
                let buffer = [];
                let lastLevel = 0;
                function flush(level) {
                    if (buffer.length === 0) return;
                    let content = buffer.join('\n');
                    if (lastLevel > 0) {
                        content = parseBlockquotes(content);
                        for (let i = 0; i < lastLevel; i++) {
                            content = `<blockquote>${content}</blockquote>`;
                        }
                    }
                    result.push(content);
                    buffer = [];
                }
                for (let line of lines) {
                    const match = line.match(/^(>+)( ?)(.*)$/);
                    if (match) {
                        const level = match[1].length;
                        if (lastLevel !== 0 && level !== lastLevel) {
                            flush(lastLevel);
                        }
                        buffer.push(match[3]);
                        lastLevel = level;
                    } else {
                        flush(lastLevel);
                        result.push(line);
                        lastLevel = 0;
                    }
                }
                flush(lastLevel);
                return result.join('\n');
            }
            html = parseBlockquotes(html);

            // Original parsing logic continues here...
            html = html
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // Horizontal rules (---, ***, ___ on their own line)
                .replace(/^(?:---|\*\*\*|___)\s*$/gm, '<hr>')

                // Bold and italic only
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')

                // Code blocks
                .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => `<pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`)
                .replace(/`([^`]+)`/g, '<code>$1</code>')

                // Links & Images
                .replace(/!\[([^\]]*)\]\(([^)]+?)(?:\s+"([^"]*)")?\)/g, function (match, alt, url, title) {
                    let info = (alt && alt.trim()) || (title && title.trim());
                    let imgTag = `<img src="${url}" alt="${alt || ''}"${title ? ` title="${title}"` : ''}>`;
                    if (info) {
                        return `<span class="md-img-info-wrap">${imgTag}<span class="md-img-info-badge" title="Image info">i</span></span>`;
                    } else {
                        return imgTag;
                    }
                })
                .replace(/\[([^\]]+)\]\(([^)]+?)(?:\s+"([^"]*)")?\)/g, function (match, text, url, title) {
                    const t = title ? ` title="${title}"` : '';
                    return `<a href="${url}"${t}>${text}</a>`;
                })
                // Autolink bare URLs
                .replace(/(^|[^"'=])(https?:\/\/[\w\-._~:\/?#\[\]@!$&'()*+,;=%]+)/g, function (m, lead, url) {
                    return `${lead}<a href="${url}">${url}</a>`;
                })
                // Autolink emails
                .replace(/(^|\s)([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})/g, function (m, lead, email) {
                    return `${lead}<a href="mailto:${email}">${email}</a>`;
                });





            // Basic unordered list processing (no task lists)
            html = html.replace(/((?:^[\*\-\+] .*$\r?\n?)+)/gm, (match) => {
                const items = match.trim().split('\n').map(line => `<li>${line.substring(2)}</li>`).join('');
                return `<ul>${items}</ul>`;
            });

            // Ordered lists
            html = html.replace(/((?:^\d+\. .*$\r?\n?)+)/gm, (match) => {
                const items = match.trim().split('\n').map(line => `<li>${line.replace(/^\d+\.\s*/, '')}</li>`).join('');
                return `<ol>${items}</ol>`;
            });

            // Line breaks and paragraphs
            html = html.replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            // Wrap in paragraphs and fix lists
            html = '<p>' + html.trim() + '</p>';

            // Cleanup: Remove <p> tags that incorrectly wrap block elements like tables or hr
            html = html.replace(/<p>\s*(<(table|ul|ol|pre|blockquote|h[1-6]|hr))/g, '$1');
            html = html.replace(/(<\/(table|ul|ol|pre|blockquote|h[1-6])>|<hr>)\s*<\/p>/g, '$1');

            html = html.replace(/<\/p><p>(<li>.*?<\/li>)<\/p><p>/g, '<ul>$1</ul>');
            html = html.replace(/<\/li><br><li>/g, '</li><li>');

            // Fix empty paragraphs
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<p><br><\/p>/g, '');



            // Restore escaped characters
            html = html.replace(/@@ESCAPED:([0-9a-f]+)@@/gi, function (match, p1) { return String.fromCharCode(parseInt(p1, 16)); });

            return html;
        }
        // Update the preview pane with parsed markdown
        function updatePreview() {
            const markdownText = editor.value;
            const htmlContent = parseMarkdown(markdownText);
            preview.innerHTML = htmlContent;
        }

        // Update the status bar with current document stats
        function updateStatusBar() {
            const text = editor.value;
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
            const charCount = text.length;
            const lineCount = text.split('\n').length;

            document.getElementById('word-count').textContent = `Words: ${wordCount}`;
            document.getElementById('char-count').textContent = `Characters: ${charCount}`;
            document.getElementById('line-count').textContent = `Lines: ${lineCount}`;
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'n':
                        e.preventDefault();
                        newFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        openFile();
                        break;
                    case 's':
                        e.preventDefault();
                        saveFile();
                        break;
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                        break;
                    case 'b':
                        e.preventDefault();
                        insertMarkdown('**', '**');
                        break;
                    case 'i':
                        e.preventDefault();
                        insertMarkdown('*', '*');
                        break;
                    case 'f':
                        e.preventDefault();
                        toggleFindReplace();
                        break;
                    case 'h':
                        e.preventDefault();
                        toggleFindReplace();
                        document.getElementById('replace-input').focus();
                        break;
                }
            }
        }

        // File operations
        function newFile() {
            if (editor.value.trim() && !confirm('Are you sure you want to create a new file? Unsaved changes will be lost.')) {
                return;
            }
            editor.value = '';
            currentFile = null;
            updatePreview();
            updateStatusBar();
            updateStatus('New file created');
        }

        function openFile() {
            document.getElementById('file-input').click();
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    editor.value = event.target.result;
                    currentFile = file.name;
                    updatePreview();
                    updateStatusBar();
                    updateStatus(`Opened: ${file.name}`);
                };
                reader.readAsText(file);
            }
        }

        function saveFile() {
            const content = editor.value;
            let filename = currentFile || 'document.md';
            // If the filename has no extension, default to .md
            if (!/\.(md|markdown|txt|text)$/i.test(filename)) {
                filename += '.md';
            }
            // Use text/plain for .txt/.text, text/markdown for .md
            let type = 'text/markdown';
            if (/\.(txt|text)$/i.test(filename)) {
                type = 'text/plain';
            }
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            updateStatus(`Saved: ${filename}`);
        }

        // Undo/Redo functionality
        function saveToUndoStack() {
            undoStack.push(editor.value);
            if (undoStack.length > 50) {
                undoStack.shift();
            }
            redoStack = [];
        }

        function undo() {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                editor.value = undoStack[undoStack.length - 1] || '';
                updatePreview();
                updateStatusBar();
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                const redoValue = redoStack.pop();
                undoStack.push(redoValue);
                editor.value = redoValue;
                updatePreview();
                updateStatusBar();
            }
        }

        // Markdown insertion helpers
        function insertMarkdown(before, after) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);

            const newText = before + selectedText + after;
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);

            // Position cursor appropriately
            if (selectedText) {
                editor.selectionStart = start;
                editor.selectionEnd = start + newText.length;
            } else {
                editor.selectionStart = editor.selectionEnd = start + before.length;
            }

            editor.focus();
            updatePreview();
            updateStatusBar();
        }

        function insertHeading(level) {
            const start = editor.selectionStart;
            const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
            const hashes = '#'.repeat(level) + ' ';

            editor.value = editor.value.substring(0, lineStart) + hashes + editor.value.substring(lineStart);
            editor.selectionStart = editor.selectionEnd = lineStart + hashes.length;
            editor.focus();
            updatePreview();
            updateStatusBar();
        }

        function insertList(prefix) {
            const start = editor.selectionStart;
            const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;

            editor.value = editor.value.substring(0, lineStart) + prefix + editor.value.substring(lineStart);
            editor.selectionStart = editor.selectionEnd = lineStart + prefix.length;
            editor.focus();
            updatePreview();
            updateStatusBar();
        }

        function insertLink() {
            showLinkImageDialog('link');
        }

        function insertImage() {
            showLinkImageDialog('image');
        }



        function showLinkImageDialog(type) {
            const dialog = document.getElementById('link-image-dialog');
            const overlay = document.getElementById('popup-overlay');
            const title = document.getElementById('dialog-title');
            const textLabel = document.getElementById('dialog-text-label');
            const urlInput = document.getElementById('dialog-url');
            const textInput = document.getElementById('dialog-text');
            const okBtn = document.getElementById('dialog-ok');
            const cancelBtn = document.getElementById('dialog-cancel');

            title.textContent = type === 'link' ? 'Insert Link' : 'Insert Image';
            textLabel.textContent = type === 'link' ? 'Text' : 'Alt Text';
            urlInput.value = '';
            textInput.value = editor.value.substring(editor.selectionStart, editor.selectionEnd);

            overlay.style.display = 'block';
            dialog.style.display = 'block';
            urlInput.focus();

            const handleOk = () => {
                const url = urlInput.value;
                const text = textInput.value;
                if (url) {
                    const markdown = type === 'link' ? `[${text || url}](${url})` : `![${text || 'Image'}](${url})`;
                    insertMarkdown(markdown, '');
                }
                closeDialog();
            };

            const handleCancel = () => {
                closeDialog();
            };

            const closeDialog = () => {
                overlay.style.display = 'none';
                dialog.style.display = 'none';
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
                editor.focus();
            };

            okBtn.addEventListener('click', handleOk);
            cancelBtn.addEventListener('click', handleCancel);
        }











        // Insert a horizontal rule line
        function insertHorizontalRule() {
            const start = editor.selectionStart;
            const ls = editor.value.lastIndexOf('\n', start - 1) + 1;
            const prefix = ls === start ? '' : '\n';
            const snippet = `${prefix}---\n`;
            editor.setRangeText(snippet, start, start, 'end');
            updatePreview();
            updateStatusBar();
        }

        // View mode management
        function setViewMode(mode) {
            currentViewMode = mode;
            const container = document.getElementById('main-container');
            // Remove all view classes
            container.classList.remove('editor-only', 'preview-only', 'single-pane');

            // Remove 'active' from all view toggle buttons
            document.getElementById('split-btn').classList.remove('active');
            document.getElementById('editor-btn').classList.remove('active');
            document.getElementById('preview-btn').classList.remove('active');

            // Always reset flex to 50/50 when switching to split view
            if (mode === 'split') {
                document.getElementById('editor-pane').style.flex = '1';
                document.getElementById('preview-pane').style.flex = '1';
                document.getElementById('split-btn').classList.add('active');
            } else if (mode === 'editor') {
                document.getElementById('editor-pane').style.flex = '';
                document.getElementById('preview-pane').style.flex = '';
                container.classList.add('editor-only', 'single-pane');
                document.getElementById('editor-btn').classList.add('active');
            } else if (mode === 'preview') {
                document.getElementById('editor-pane').style.flex = '';
                document.getElementById('preview-pane').style.flex = '';
                container.classList.add('preview-only', 'single-pane');
                document.getElementById('preview-btn').classList.add('active');
            }
        }

        // Splitter functionality for resizing panes
        function setupSplitter() {
            const splitter = document.getElementById('splitter');
            let isResizing = false;

            splitter.addEventListener('mousedown', function (e) {
                isResizing = true;
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
            });

            function handleMouseMove(e) {
                if (!isResizing) return;

                const container = document.getElementById('main-container');
                const containerRect = container.getBoundingClientRect();
                const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;

                if (percentage > 20 && percentage < 80) {
                    document.getElementById('editor-pane').style.flex = `0 1 ${percentage}%`;
                    document.getElementById('preview-pane').style.flex = `1 1 ${100 - percentage}%`;
                }
            }

            function handleMouseUp() {
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        }

        // Utility functions
        function updateStatus(message) {
            document.getElementById('status-left').textContent = message;
            setTimeout(() => {
                document.getElementById('status-left').textContent = 'Ready';
            }, 3000);
        }

        // Custom alert function
        function customAlert(message, callback) {
            const alertBox = document.getElementById('custom-alert');
            const overlay = document.getElementById('popup-overlay');
            const msgEl = document.getElementById('custom-alert-message');
            const okBtn = document.getElementById('custom-alert-ok');

            msgEl.textContent = message;
            overlay.style.display = 'block';
            alertBox.style.display = 'block';

            const closeAlert = () => {
                alertBox.style.display = 'none';
                overlay.style.display = 'none';
                okBtn.removeEventListener('click', closeAlert);
                if (callback) callback();
            };
            okBtn.addEventListener('click', closeAlert);
        }

        // Menu functions (placeholder implementations)
        function showAbout() {
            document.getElementById('changelog-popup').style.display = 'block';
            document.getElementById('popup-overlay').style.display = 'block';
        }


        function showEditMenu() {
            customAlert('Edit menu - Use Ctrl+Z/Ctrl+Y for undo/redo, or the toolbar buttons.');
        }

        function showViewMenu() {
            customAlert('View menu - Use the view toggle buttons to switch between Editor, Preview, and Split view.');
        }

        function showHelp() {
            document.getElementById('help-popup').style.display = 'block';
            document.getElementById('popup-overlay').style.display = 'block';
        }
        // Hide help popup
        document.addEventListener('DOMContentLoaded', function () {
            var closeBtn = document.getElementById('help-popup-close');
            if (closeBtn) closeBtn.onclick = function () {
                document.getElementById('help-popup').style.display = 'none';
                document.getElementById('popup-overlay').style.display = 'none';
            };
            // Also close when clicking overlay
            var overlay = document.getElementById('popup-overlay');
            if (overlay) overlay.addEventListener('click', function () {
                document.getElementById('help-popup').style.display = 'none';
                overlay.style.display = 'none';
            });
        });

        // Handle image info badge clicks
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('md-img-info-badge')) {
                // Hide any other open popups
                document.querySelectorAll('.md-img-info-popup').forEach(popup => {
                    if (popup !== e.target.nextElementSibling) {
                        popup.style.display = 'none';
                    }
                });

                // Toggle this popup
                const popup = e.target.nextElementSibling;
                popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
            } else if (!e.target.closest('.md-img-info-popup')) {
                // Click outside popup - hide all popups
                document.querySelectorAll('.md-img-info-popup').forEach(popup => {
                    popup.style.display = 'none';
                });
            }
        });

        // Initialize the editor when page loads
        window.addEventListener('load', initEditor);
    </script>
</body>

</html>